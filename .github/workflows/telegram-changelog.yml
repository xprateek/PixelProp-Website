name: Notify Telegram (file locations and line ranges)

on:
  push:

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      GROUP_ID: ${{ secrets.GROUP_ID }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine range
        id: range
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ -z "${BEFORE}" ] || [ "${BEFORE}" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="0000000000000000000000000000000000000000"
          fi
          echo "before=${BEFORE}" >> "$GITHUB_OUTPUT"
          echo "after=${AFTER}" >> "$GITHUB_OUTPUT"

      - name: Build message (commits, files, locations)
        run: |
          set -euo pipefail
          BEFORE="${{ steps.range.outputs.before }}"
          AFTER="${{ steps.range.outputs.after }}"
          REPO="${{ github.repository }}"
          REF="${{ github.ref }}"
          API="https://api.telegram.org/bot${BOT_TOKEN}"

          mkdir -p /tmp/tgmsg
          COMMITS=/tmp/tgmsg/commits.txt
          FILES=/tmp/tgmsg/files.txt
          LOCS=/tmp/tgmsg/locations.txt
          MESSAGE=/tmp/tgmsg/message.html

          if [ "${BEFORE}" = "${AFTER}" ]; then
            RANGE="${AFTER}"
            SHORT_RANGE="${AFTER:0:7}"
          else
            RANGE="${BEFORE}..${AFTER}"
            SHORT_RANGE="${BEFORE:0:7}..${AFTER:0:7}"
          fi

          if [ "${RANGE}" = "${AFTER}" ]; then
            git --no-pager log -1 --pretty=format:"%h|%an|%ad|%s" --date=iso "${AFTER}" > "${COMMITS}" 2>/dev/null || true
            git --no-pager show --name-status --pretty="" "${AFTER}" | sed '/^$/d' > "${FILES}" 2>/dev/null || true
          else
            git --no-pager log --reverse --pretty=format:"%h|%an|%ad|%s" --date=iso "${BEFORE}..${AFTER}" > "${COMMITS}" 2>/dev/null || true
            git --no-pager diff --name-status "${BEFORE}" "${AFTER}" | sed '/^$/d' > "${FILES}" 2>/dev/null || true
          fi

          : > "${LOCS}"
          while IFS=$'\t' read -r status path; do
            [ -z "${path}" ] && continue
            echo "FILE|${status}|${path}" >> "${LOCS}"

            if [ "${RANGE}" = "${AFTER}" ]; then
              hunk_output=$(git --no-pager show --unified=0 "${AFTER}" -- "${path}" 2>/dev/null || true)
            else
              hunk_output=$(git --no-pager diff --unified=0 "${BEFORE}" "${AFTER}" -- "${path}" 2>/dev/null || true)
            fi

            if [ -n "${hunk_output}" ]; then
              echo "${hunk_output}" | grep '^@@ ' | while read -r hunk_line; do
                old_part=$(echo "${hunk_line}" | sed -n 's/.*-\([0-9][0-9,]*\).*/\1/p' || true)
                new_part=$(echo "${hunk_line}" | sed -n 's/.*+\([0-9][0-9,]*\).*/\1/p' || true)

                parse_range() {
                  r="$1"
                  if echo "${r}" | grep -q ','; then
                    start=$(echo "${r}" | cut -d, -f1)
                    len=$(echo "${r}" | cut -d, -f2)
                  else
                    start="${r}"
                    len=1
                  fi
                  end=$((start + len - 1))
                  printf "%s %s %s\n" "${start}" "${end}" "${len}"
                }

                if [ -n "${new_part}" ]; then
                  read new_start new_end new_len <<< "$(parse_range "${new_part}")"
                  echo "LOC|added|${path}|${new_start}|${new_end}|${new_len}" >> "${LOCS}"
                fi

                if [ -n "${old_part}" ]; then
                  read old_start old_end old_len <<< "$(parse_range "${old_part}")"
                  echo "LOC|removed|${path}|${old_start}|${old_end}|${old_len}" >> "${LOCS}"
                fi
              done
            fi
          done < "${FILES}"

          {
            echo "<b>Repository:</b> ${REPO}"
            echo "<b>Branch:</b> <code>${REF##*/}</code>"
            echo "<b>Range:</b> <code>${SHORT_RANGE}</code>"
            echo ""
            echo "<b>Commits</b>:"
            while IFS='|' read -r short author date subject; do
              esc_subj=$(echo "${subject}" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')
              echo "&nbsp;&nbsp;- <code>${short}</code> - ${esc_subj} (by ${author} at ${date})"
            done < "${COMMITS}"
            echo ""
            echo "<b>Files changed</b>:"
            filecount=0
            while IFS= read -r line; do
              filecount=$((filecount+1))
              if [ "${filecount}" -le 50 ]; then
                esc=$(echo "${line}" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')
                echo "&nbsp;&nbsp;- <code>${esc}</code>"
              fi
            done < "${FILES}"
            if [ "${filecount}" -gt 50 ]; then
              echo "&nbsp;&nbsp;... plus $((filecount-50)) more files"
            fi
            echo ""
            echo "<b>Locations (file and line ranges where changes occurred)</b>:"
            while IFS= read -r item; do
              IFS='|' read -r tag a b c d e <<< "${item}" || true
              if [ "${tag}" = "FILE" ]; then
                esc_file=$(echo "${item}" | sed -n 's/^FILE|//p' | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')
                echo "&nbsp;&nbsp;<code>${esc_file}</code>"
              elif [ "${tag}" = "LOC" ]; then
                type="${a}"
                path="${b}"
                start="${c}"
                end="${d}"
                len="${e}"
                if [ "${type}" = "added" ]; then
                  echo "&nbsp;&nbsp;<code>added ${start}-${end} (+${len}) in ${path}</code>"
                else
                  echo "&nbsp;&nbsp;<code>removed ${start}-${end} (-${len}) in ${path}</code>"
                fi
              fi
            done < "${LOCS}"
            echo ""
            echo "<b>Compare</b>: https://github.com/${REPO}/compare/${BEFORE}...${AFTER}"
          } > "${MESSAGE}"

          curl -sS -X POST "${API}/sendMessage" \
            -d chat_id="${GROUP_ID}" \
            -d parse_mode=HTML \
            --data-urlencode "text@${MESSAGE}" || true
